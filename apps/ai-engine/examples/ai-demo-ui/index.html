<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telar AI Engine Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: #fafbfc;
        }
        .section h2 {
            margin-top: 0;
            color: #555;
            font-size: 18px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            resize: vertical;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            min-height: 60px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            color: #495057;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 150px;
        }
        .status-log.active {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .provider-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
        }
        .sources-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
        }
        .sources-section h4 {
            margin-top: 0;
            color: #856404;
        }
        .source-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }
        .source-score {
            font-weight: bold;
            color: #495057;
        }
        .source-text {
            margin-top: 5px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .quick-content {
            margin-top: 10px;
        }
        .quick-content button {
            background: #6c757d;
            font-size: 12px;
            padding: 6px 12px;
            margin: 2px;
        }
        .quick-content button:hover {
            background: #5a6268;
        }
        
        /* Flow Diagram Styles */
        .flow-diagram {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
        }
        
        .flow-step {
            display: inline-block;
            padding: 8px 12px;
            margin: 2px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: #ffffff;
            color: #6c757d;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 90px;
            position: relative;
            text-align: center;
            vertical-align: middle;
        }
        
        .flow-step-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .flow-step-icon {
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .flow-step-name {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .flow-step-tech {
            font-size: 8px;
            opacity: 0.8;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .flow-step.idle {
            border-color: #dee2e6;
            background: #ffffff;
            color: #6c757d;
        }
        
        .flow-step.active {
            border-color: #007bff;
            background: #e3f2fd;
            color: #0056b3;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .flow-step.complete {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        
        .flow-step.error {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        
        .flow-arrow {
            display: inline-block;
            margin: 0 8px;
            color: #6c757d;
            font-size: 16px;
            font-weight: bold;
            vertical-align: middle;
            line-height: 1;
        }
        
        .flow-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        /* Markdown content styling */
        .markdown-content {
            line-height: 1.6;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #333;
        }
        
        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.3em; }
        .markdown-content h3 { font-size: 1.1em; }
        
        .markdown-content p {
            margin-bottom: 1em;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }
        
        .markdown-content li {
            margin-bottom: 0.3em;
        }
        
        .markdown-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            color: #d63384;
        }
        
        .markdown-content pre {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 1em;
            border: 1px solid #dee2e6;
        }
        
        .markdown-content pre code {
            background: none;
            padding: 0;
            color: #495057;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #007bff;
            padding-left: 1em;
            margin: 1em 0;
            color: #6c757d;
            font-style: italic;
        }
        
        .markdown-content strong {
            font-weight: 600;
            color: #333;
        }
        
        .markdown-content em {
            font-style: italic;
            color: #555;
        }
        
        .markdown-content a {
            color: #007bff;
            text-decoration: none;
        }
        
        .markdown-content a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 Telar AI Engine Demo</h1>
        
        <div class="provider-info">
            <strong>Current Provider:</strong> <span id="provider">Loading...</span>
            
            <!-- RAG Pipeline Flow Diagram -->
            <div class="flow-diagram">
                <div class="flow-title">RAG Pipeline Status</div>
                <div class="flow-container">
                    <span class="flow-step idle" id="step-ingest">
                        <div class="flow-step-content">
                            <div class="flow-step-icon">📄</div>
                            <div class="flow-step-name">INGEST</div>
                            <div class="flow-step-tech">Go API</div>
                        </div>
                    </span>
                    <span class="flow-arrow">→</span>
                    <span class="flow-step idle" id="step-embed">
                        <div class="flow-step-content">
                            <div class="flow-step-icon">🧠</div>
                            <div class="flow-step-name">EMBED</div>
                            <div class="flow-step-tech">Ollama</div>
                        </div>
                    </span>
                    <span class="flow-arrow">→</span>
                    <span class="flow-step idle" id="step-store">
                        <div class="flow-step-content">
                            <div class="flow-step-icon">🗄️</div>
                            <div class="flow-step-name">STORE</div>
                            <div class="flow-step-tech">Weaviate</div>
                        </div>
                    </span>
                    <span class="flow-arrow">→</span>
                    <span class="flow-step idle" id="step-query">
                        <div class="flow-step-content">
                            <div class="flow-step-icon">❓</div>
                            <div class="flow-step-name">QUERY</div>
                            <div class="flow-step-tech">Go API</div>
                        </div>
                    </span>
                    <span class="flow-arrow">→</span>
                    <span class="flow-step idle" id="step-retrieve">
                        <div class="flow-step-content">
                            <div class="flow-step-icon">🔍</div>
                            <div class="flow-step-name">RETRIEVE</div>
                            <div class="flow-step-tech">Weaviate</div>
                        </div>
                    </span>
                    <span class="flow-arrow">→</span>
                    <span class="flow-step idle" id="step-generate">
                        <div class="flow-step-content">
                            <div class="flow-step-icon">⚡</div>
                            <div class="flow-step-name">GENERATE</div>
                            <div class="flow-step-tech">Groq/Ollama</div>
                        </div>
                    </span>
                </div>
            </div>
        </div>

        <!-- 1. INGESTION SECTION -->
        <div class="section">
            <h2>📄 Knowledge Ingestion</h2>
            <div class="input-group">
                <label for="documentText">Paste document content here:</label>
                <textarea id="documentText" placeholder="Paste the content of README.md, CONTRIBUTING.md, or any document you want to add to the knowledge base..."></textarea>
            </div>
            <div class="quick-content">
                <strong>Quick Load:</strong>
                <button onclick="loadReadme()">Load README.md</button>
                <button onclick="loadContributing()">Load CONTRIBUTING.md</button>
                <button onclick="clearDocument()">Clear</button>
            </div>
            <br>
            <button onclick="ingestDocument()" id="ingestBtn">📥 Ingest Knowledge</button>
        </div>

        <!-- 2. STATUS LOG SECTION -->
        <div class="section">
            <h2>📋 Status Log</h2>
            <div id="statusLog" class="status-log">Ready to ingest documents and answer questions...</div>
        </div>

        <!-- 3. QUERY SECTION -->
        <div class="section">
            <h2>❓ Ask Questions</h2>
            <div class="input-group">
                <label for="question">Ask a question about the ingested knowledge:</label>
                <input type="text" id="question" placeholder="e.g., What is Telar built with?" />
            </div>
            <button onclick="askQuestion()" id="askBtn">🔍 Ask Question</button>
        </div>

        <!-- 4. RESULTS SECTION -->
        <div id="result" class="result" style="display: none;">
            <div id="resultContent"></div>
            <div id="sourcesSection" class="sources-section" style="display: none;">
                <h4>📚 Sources Used (RAG Evidence)</h4>
                <div id="sourcesContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentProvider = 'unknown';
        
        // Status logging utility
        function addStatus(message, isActive = false) {
            const statusLog = document.getElementById('statusLog');
            const timestamp = new Date().toLocaleTimeString();
            statusLog.textContent += `[${timestamp}] ${message}\n`;
            statusLog.scrollTop = statusLog.scrollHeight;
            
            if (isActive) {
                statusLog.classList.add('active');
            } else {
                statusLog.classList.remove('active');
            }
        }

        // Flow diagram control utilities
        function resetFlowDiagram() {
            const steps = ['step-ingest', 'step-embed', 'step-store', 'step-query', 'step-retrieve', 'step-generate'];
            steps.forEach(stepId => {
                const element = document.getElementById(stepId);
                element.className = 'flow-step idle';
            });
        }

        function setFlowStep(stepId, state) {
            const element = document.getElementById(stepId);
            element.className = `flow-step ${state}`;
        }

        function highlightFlowStep(stepId) {
            setFlowStep(stepId, 'active');
        }

        function completeFlowStep(stepId) {
            setFlowStep(stepId, 'complete');
        }

        function errorFlowStep(stepId) {
            setFlowStep(stepId, 'error');
        }

        // Markdown rendering utility
        function renderMarkdown(text) {
            try {
                // configure marked for security and better rendering
                marked.setOptions({
                    breaks: true,        // convert \n to <br>
                    gfm: true,          // github flavored markdown
                    sanitize: false,    // allow HTML (safe since it's our own content)
                    smartLists: true,   // better list handling
                    smartypants: true   // smart quotes and dashes
                });
                
                return marked.parse(text);
            } catch (error) {
                console.warn('Markdown parsing failed, falling back to plain text:', error);
                return text.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/\n/g, '<br>');
            }
        }

        // Quick load functions
        async function loadReadme() {
            addStatus('Loading README.md from GitHub...', true);
            try {
                const response = await fetch('https://raw.githubusercontent.com/qolzam/telar/main/README.md');
                const text = await response.text();
                document.getElementById('documentText').value = text;
                addStatus('README.md loaded successfully!');
            } catch (error) {
                addStatus(`Error loading README.md: ${error.message}`);
            }
        }

        async function loadContributing() {
            addStatus('Loading CONTRIBUTING.md from GitHub...', true);
            try {
                const response = await fetch('https://raw.githubusercontent.com/qolzam/telar/main/CONTRIBUTING.md');
                const text = await response.text();
                document.getElementById('documentText').value = text;
                addStatus('CONTRIBUTING.md loaded successfully!');
            } catch (error) {
                addStatus(`Error loading CONTRIBUTING.md: ${error.message}`);
            }
        }

        function clearDocument() {
            document.getElementById('documentText').value = '';
            addStatus('Document content cleared.');
        }

        // Check current provider
        async function checkProvider() {
            try {
                const response = await fetch('http://localhost:8000/health');
                const data = await response.json();
                
                // determine provider based on health status
                if (data.status === 'healthy') {
                    currentProvider = 'Hybrid (Ollama + Groq)';
                } else if (data.services?.llm === 'healthy') {
                    currentProvider = 'Ollama Only';
                } else {
                    currentProvider = 'Unknown';
                }
                
                document.getElementById('provider').textContent = currentProvider;
                addStatus(`Provider detected: ${currentProvider}`);
            } catch (error) {
                document.getElementById('provider').textContent = 'Offline';
                addStatus('Error: AI Engine appears to be offline');
            }
        }

        // Ingest document
        async function ingestDocument() {
            const documentText = document.getElementById('documentText').value.trim();
            if (!documentText) {
                alert('Please paste some document content first');
                return;
            }

            const ingestBtn = document.getElementById('ingestBtn');
            const originalText = ingestBtn.textContent;
            
            // reset and start flow diagram
            resetFlowDiagram();
            
            // show loading state
            ingestBtn.disabled = true;
            ingestBtn.textContent = '📥 Ingesting...';
            addStatus('Starting document ingestion...', true);
            
            // step 1: ingest
            highlightFlowStep('step-ingest');

            try {
                const startTime = Date.now();
                
                // step 2: embed
                completeFlowStep('step-ingest');
                highlightFlowStep('step-embed');
                addStatus('Generating embeddings...');
                
                // simulate embedding delay for visual effect
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const response = await fetch('http://localhost:8000/api/v1/ingest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: documentText,
                        metadata: {
                            source: "demo-upload",
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                // step 3: store
                completeFlowStep('step-embed');
                highlightFlowStep('step-store');
                addStatus('Storing in Weaviate...');

                const endTime = Date.now();
                const responseTime = endTime - startTime;

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || errorData.error || 'Ingestion failed');
                }

                const data = await response.json();
                
                // complete the ingestion flow
                completeFlowStep('step-store');
                addStatus(`✅ Ingestion complete! (${responseTime}ms)`);
                addStatus(`Document ID: ${data.id}`);
                
                // clear the textarea after successful ingestion
                document.getElementById('documentText').value = '';

            } catch (error) {
                // mark current step as error
                const activeStep = document.querySelector('.flow-step.active');
                if (activeStep) {
                    errorFlowStep(activeStep.id);
                }
                addStatus(`❌ Ingestion failed: ${error.message}`);
            } finally {
                ingestBtn.disabled = false;
                ingestBtn.textContent = originalText;
            }
        }

        // Ask question
        async function askQuestion() {
            const question = document.getElementById('question').value.trim();
            if (!question) {
                alert('Please enter a question');
                return;
            }
            
            const askBtn = document.getElementById('askBtn');
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            const sourcesSection = document.getElementById('sourcesSection');
            const sourcesContent = document.getElementById('sourcesContent');
            
            // Show loading state
            askBtn.disabled = true;
            askBtn.textContent = '🤔 Thinking...';
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultContent.innerHTML = '🤔 Processing your question...';
            sourcesSection.style.display = 'none';
            addStatus(`Querying: "${question}"`, true);
            
            // eeset flow and start query process
            resetFlowDiagram();
            highlightFlowStep('step-query');
            
            try {
                const startTime = Date.now();
                
                // step 1: query processing
                completeFlowStep('step-query');
                highlightFlowStep('step-retrieve');
                addStatus('Searching knowledge base...');
                
                const response = await fetch('http://localhost:8000/api/v1/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question })
                });
                
                // step 2: generate response
                completeFlowStep('step-retrieve');
                highlightFlowStep('step-generate');
                addStatus('Generating response...');
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || errorData.error || 'Request failed');
                }
                
                const data = await response.json();
                
                // complete the query flow
                completeFlowStep('step-generate');
                
                // show success result
                resultDiv.className = 'result success';
                const renderedAnswer = renderMarkdown(data.answer);
                resultContent.innerHTML = `
                    <h3>💡 Answer:</h3>
                    <div class="markdown-content">${renderedAnswer}</div>
                    <hr>
                    <p><strong>⚡ Response Time:</strong> ${responseTime}ms</p>
                    <p><strong>🔧 Provider:</strong> ${currentProvider}</p>
                `;

                // show sources if available
                if (data.sources && data.sources.length > 0) {
                    sourcesSection.style.display = 'block';
                    sourcesContent.innerHTML = data.sources.map((source, index) => `
                        <div class="source-item">
                            <div class="source-score">Source #${index + 1} - Relevance Score: ${source.score.toFixed(3)}</div>
                            <div class="source-text">${source.text.substring(0, 300)}${source.text.length > 300 ? '...' : ''}</div>
                        </div>
                    `).join('');
                    addStatus(`✅ Query complete! Found ${data.sources.length} relevant sources (${responseTime}ms)`);
                } else {
                    addStatus(`✅ Query complete! No sources found - knowledge base may be empty (${responseTime}ms)`);
                }
                
            } catch (error) {
                // mark current step as error
                const activeStep = document.querySelector('.flow-step.active');
                if (activeStep) {
                    errorFlowStep(activeStep.id);
                }
                
                // show error result
                resultDiv.className = 'result error';
                resultContent.innerHTML = `
                    <h3>❌ Error:</h3>
                    <p>${error.message}</p>
                    <hr>
                    <p><strong>🔧 Provider:</strong> ${currentProvider}</p>
                `;
                addStatus(`❌ Query failed: ${error.message}`);
            } finally {
                askBtn.disabled = false;
                askBtn.textContent = '🔍 Ask Question';
            }
        }
        
        // allow enter key to submit
        document.getElementById('question').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askQuestion();
            }
        });
        
        // initialize
        checkProvider();
    </script>
</body>
</html>
